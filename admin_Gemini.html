<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koco Delight - Admin Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #1F2937; --secondary: #F59E0B; --background: #111827; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); }
        .glass { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .status-pending { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .status-confirmed { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .status-preparing { background: rgba(168, 85, 247, 0.2); color: #A855F7; }
        .status-ready { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .status-delivered { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .loading-spinner { border: 4px solid #374151; border-top: 4px solid var(--secondary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { background: var(--secondary) !important; color: var(--primary) !important; }
        .filter-active { background: var(--secondary) !important; color: var(--primary) !important; }
        .drag-drop-zone.drag-over { border-color: #FCD34D; background: rgba(252, 211, 77, 0.1); }
    </style>
</head>
<body class="text-white">
    
    <div id="signin-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-40">
        <div class="glass rounded-3xl p-8 mx-4 max-w-sm w-full text-center">
            <h1 class="text-3xl font-bold text-yellow-400 mb-2">Admin Login</h1>
            <p class="text-gray-300 mb-8">Sign in to manage Koco Delight</p>
            <button onclick="signInWithGoogle()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 font-bold py-3 rounded-xl text-lg hover:scale-105 transition-transform">
                <i class="fab fa-google mr-3"></i>Sign in
            </button>
        </div>
    </div>

    <div id="access-denied-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-40 hidden">
        <div class="glass rounded-3xl p-8 text-center">
            <h1 class="text-2xl font-bold text-red-400 mb-4">Access Denied</h1>
            <button onclick="signOut()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-xl">Sign Out</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="glass sticky top-0 z-30 border-b border-gray-700">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-xl font-bold text-yellow-400">Koco Admin</h1>
                <div class="flex items-center space-x-3">
                    <img id="admin-avatar" class="w-10 h-10 rounded-full border-2 border-yellow-400" src="" alt="Admin">
                    <button onclick="signOut()" class="text-red-400 hover:text-red-300"><i class="fas fa-sign-out-alt text-lg"></i></button>
                </div>
            </div>
        </header>

        <section class="container mx-auto px-4 py-6 grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass rounded-2xl p-4 text-center"><div class="text-3xl font-bold text-yellow-400" id="total-orders">0</div><div class="text-sm text-gray-400">Orders</div></div>
            <div class="glass rounded-2xl p-4 text-center"><div class="text-3xl font-bold text-green-400" id="total-revenue">$0</div><div class="text-sm text-gray-400">Revenue</div></div>
            <div class="glass rounded-2xl p-4 text-center"><div class="text-3xl font-bold text-purple-400" id="total-chocolates">0</div><div class="text-sm text-gray-400">Chocolates</div></div>
            <div class="glass rounded-2xl p-4 text-center"><div class="text-3xl font-bold text-blue-400" id="total-stories">0</div><div class="text-sm text-gray-400">Stories</div></div>
        </section>

        <section class="container mx-auto px-4 mb-6">
            <div class="glass rounded-2xl p-2 grid grid-cols-3 gap-2">
                <button onclick="showTab('orders')" class="tab-button tab-active py-3 px-4 rounded-xl font-medium" data-tab="orders">Orders</button>
                <button onclick="showTab('chocolates')" class="tab-button py-3 px-4 rounded-xl font-medium hover:bg-white/10" data-tab="chocolates">Chocolates</button>
                <button onclick="showTab('storybooks')" class="tab-button py-3 px-4 rounded-xl font-medium hover:bg-white/10" data-tab="storybooks">Storybooks</button>
            </div>
        </section>

        <!-- Orders Tab -->
        <section id="orders-tab" class="container mx-auto px-4 pb-20">
             <div id="orders-container" class="space-y-4"><!-- Orders Populated Here --></div>
             <div id="orders-loading" class="text-center py-12"><div class="loading-spinner mx-auto"></div><p class="mt-4">Loading orders...</p></div>
        </section>

        <!-- Chocolates Tab -->
        <section id="chocolates-tab" class="container mx-auto px-4 pb-20 hidden">
            <button onclick="showChocolateModal()" class="bg-yellow-500 text-gray-900 font-bold py-2 px-4 rounded-lg mb-6"><i class="fas fa-plus mr-2"></i>Add Chocolate</button>
            <div id="chocolates-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Chocolates Populated Here --></div>
            <div id="chocolates-loading" class="text-center py-12"><div class="loading-spinner mx-auto"></div><p class="mt-4">Loading chocolates...</p></div>
        </section>

        <!-- Storybooks Tab -->
        <section id="storybooks-tab" class="container mx-auto px-4 pb-20 hidden">
            <button onclick="showStorybookModal()" class="bg-yellow-500 text-gray-900 font-bold py-2 px-4 rounded-lg mb-6"><i class="fas fa-plus mr-2"></i>Add Story</button>
            <div id="storybooks-container" class="space-y-4"><!-- Storybooks Populated Here --></div>
            <div id="storybooks-loading" class="text-center py-12"><div class="loading-spinner mx-auto"></div><p class="mt-4">Loading storybooks...</p></div>
        </section>

    </div>

    <!-- Modals -->
    <div id="chocolate-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="glass rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <form id="chocolate-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold text-yellow-400" id="chocolate-modal-title">Add Chocolate</h3>
                <input type="text" id="chocolate-name" placeholder="Name" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg">
                <input type="number" id="chocolate-price" placeholder="Price" step="0.01" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg">
                <input type="text" id="chocolate-emoji" placeholder="Emoji" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg">
                <textarea id="chocolate-description" placeholder="Description" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg"></textarea>
                <div id="image-drop-zone" class="drag-drop-zone p-6 text-center border-2 border-dashed border-gray-600 rounded-lg">
                     <p>Drag & drop image or click to upload</p>
                     <input type="file" id="chocolate-image" accept="image/*" class="hidden">
                     <img id="image-preview" class="hidden mx-auto mt-4 max-h-40 rounded-lg"/>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" id="chocolate-submit-btn" class="flex-1 bg-yellow-500 text-gray-900 font-bold py-2 rounded-lg">Save</button>
                    <button type="button" onclick="closeChocolateModal()" class="flex-1 bg-gray-600 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="storybook-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="glass rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <form id="storybook-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold text-yellow-400" id="storybook-modal-title">Add Storybook</h3>
                <select id="storybook-chocolate-id" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg"></select>
                <input type="text" id="storybook-title" placeholder="Title" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg">
                <textarea id="storybook-content" placeholder="Content" rows="10" required class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg"></textarea>
                <div class="flex space-x-2">
                    <button type="submit" id="storybook-submit-btn" class="flex-1 bg-yellow-500 text-gray-900 font-bold py-2 rounded-lg">Save</button>
                    <button type="button" onclick="closeStorybookModal()" class="flex-1 bg-gray-600 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBs-7nJ3-L2IISbkB_B2PB6E_1y9ZmImUw",
            authDomain: "koco-delight.firebaseapp.com",
            projectId: "koco-delight",
            storageBucket: "koco-delight.firebasestorage.app",
            messagingSenderId: "587407788224",
            appId: "1:587407788224:web:dfe3a40919aabfc2200525"
        };
        const ADMIN_EMAILS = ['moabrarakhunji@gmail.com', 'kamilganiji@gmail.com', 'kocodelight083@gmail.com'];

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let allOrders = [], allChocolates = [], allStorybooks = [];
        let currentChocolateId = null, currentStorybookId = null, currentImageFile = null;

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('signin-screen').classList.add('hidden');
                document.getElementById('admin-avatar').src = user.photoURL;
                loadAllData();
            } else {
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById(user ? 'access-denied-screen' : 'signin-screen').classList.remove('hidden');
            }
        });

        const signInWithGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        const signOut = () => auth.signOut();

        // --- DATA LOADING & RENDERING ---
        async function loadAllData() {
            loadOrders();
            loadChocolates();
            loadStorybooks();
        }

        const loadOrders = () => db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(snap => {
            allOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderOrders();
            document.getElementById('total-orders').textContent = allOrders.length;
            document.getElementById('total-revenue').textContent = `$${allOrders.reduce((sum, o) => sum + o.totalPrice, 0).toFixed(0)}`;
        });
        const loadChocolates = () => db.collection('chocolates').orderBy('name').onSnapshot(snap => {
            allChocolates = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderChocolates();
            populateChocolateDropdown();
            document.getElementById('total-chocolates').textContent = allChocolates.length;
        });
        const loadStorybooks = () => db.collection('storybooks').orderBy('title').onSnapshot(snap => {
            allStorybooks = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStorybooks();
            document.getElementById('total-stories').textContent = allStorybooks.length;
        });
        
        const renderOrders = () => {
            const container = document.getElementById('orders-container');
            container.innerHTML = allOrders.map(o => `
                <div class="glass p-4 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">${o.customerName}</p>
                            <p class="text-sm text-gray-400">${o.orderId}</p>
                        </div>
                        <span class="status-${o.status} px-2 py-1 rounded-full text-xs font-semibold">${o.status}</span>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <p class="text-sm">${o.items.map(i => i.emoji).join(' ')}</p>
                        <p class="font-bold text-lg text-green-400">$${o.totalPrice.toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
            document.getElementById('orders-loading').style.display = 'none';
        };

        const renderChocolates = () => {
            const container = document.getElementById('chocolates-container');
            container.innerHTML = allChocolates.map(c => `
                <div class="glass p-4 rounded-lg">
                     <img src="${c.imageUrl}" class="w-full h-32 object-cover rounded-md mb-2">
                     <h4 class="font-bold text-lg">${c.name}</h4>
                     <p class="text-sm text-gray-400">${c.description}</p>
                     <div class="flex justify-between items-center mt-2">
                        <span class="font-bold text-green-400">$${c.price.toFixed(2)}</span>
                        <div>
                            <button onclick="editChocolate('${c.id}')" class="text-blue-400 hover:text-blue-300 p-1"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem('chocolates', '${c.id}')" class="text-red-400 hover:text-red-300 p-1"><i class="fas fa-trash"></i></button>
                        </div>
                     </div>
                </div>
            `).join('');
            document.getElementById('chocolates-loading').style.display = 'none';
        };
        
        const renderStorybooks = () => {
            const container = document.getElementById('storybooks-container');
            const chocoName = (id) => allChocolates.find(c => c.id === id)?.name || 'Unknown';
            container.innerHTML = allStorybooks.map(s => `
                <div class="glass p-4 rounded-lg">
                    <h4 class="font-bold text-lg">${s.title}</h4>
                    <p class="text-sm text-yellow-400">For: ${s.chocolateName || chocoName(s.chocolateId)}</p>
                    <p class="text-sm text-gray-400 mt-1 truncate">${s.content}</p>
                    <div class="text-right mt-2">
                        <button onclick="editStorybook('${s.id}')" class="text-blue-400 p-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteItem('storybooks', '${s.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            document.getElementById('storybooks-loading').style.display = 'none';
        };

        const populateChocolateDropdown = () => {
            const select = document.getElementById('storybook-chocolate-id');
            select.innerHTML = '<option value="">Select a Chocolate</option>' + allChocolates.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // --- CHOCOLATE MODAL & FORM ---
        const showChocolateModal = () => {
            currentChocolateId = null;
            document.getElementById('chocolate-form').reset();
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('chocolate-modal-title').textContent = 'Add Chocolate';
            document.getElementById('chocolate-modal').classList.remove('hidden');
        };
        const closeChocolateModal = () => document.getElementById('chocolate-modal').classList.add('hidden');

        const editChocolate = id => {
            currentChocolateId = id;
            const chocolate = allChocolates.find(c => c.id === id);
            Object.keys(chocolate).forEach(key => {
                const el = document.getElementById(`chocolate-${key}`);
                if (el) el.value = chocolate[key];
            });
            const preview = document.getElementById('image-preview');
            preview.src = chocolate.imageUrl;
            preview.classList.remove('hidden');
            document.getElementById('chocolate-modal-title').textContent = 'Edit Chocolate';
            document.getElementById('chocolate-modal').classList.remove('hidden');
        };

        document.getElementById('chocolate-form').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('chocolate-submit-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            let imageUrl = document.getElementById('image-preview').src;
            if (currentImageFile) {
                const ref = storage.ref(`chocolates/${Date.now()}_${currentImageFile.name}`);
                const snapshot = await ref.put(currentImageFile);
                imageUrl = await snapshot.ref.getDownloadURL();
            }

            const data = {
                name: document.getElementById('chocolate-name').value,
                price: parseFloat(document.getElementById('chocolate-price').value),
                emoji: document.getElementById('chocolate-emoji').value,
                description: document.getElementById('chocolate-description').value,
                imageUrl: imageUrl
            };

            const action = currentChocolateId 
                ? db.collection('chocolates').doc(currentChocolateId).update(data)
                : db.collection('chocolates').add(data);
            
            await action;
            await updateWebsiteData();
            closeChocolateModal();
            btn.disabled = false;
            btn.textContent = 'Save';
            currentImageFile = null;
        });

        // --- STORYBOOK MODAL & FORM ---
        const showStorybookModal = () => {
            currentStorybookId = null;
            document.getElementById('storybook-form').reset();
            document.getElementById('storybook-modal-title').textContent = 'Add Storybook';
            document.getElementById('storybook-modal').classList.remove('hidden');
        };
        const closeStorybookModal = () => document.getElementById('storybook-modal').classList.add('hidden');
        
        const editStorybook = id => {
            currentStorybookId = id;
            const story = allStorybooks.find(s => s.id === id);
             document.getElementById('storybook-chocolate-id').value = story.chocolateId;
             document.getElementById('storybook-title').value = story.title;
             document.getElementById('storybook-content').value = story.content;
            document.getElementById('storybook-modal-title').textContent = 'Edit Storybook';
            document.getElementById('storybook-modal').classList.remove('hidden');
        };

        document.getElementById('storybook-form').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('storybook-submit-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const chocolateId = document.getElementById('storybook-chocolate-id').value;
            const selectedChoco = allChocolates.find(c => c.id === chocolateId);

            const data = {
                chocolateId: chocolateId,
                chocolateName: selectedChoco ? selectedChoco.name : 'Unknown',
                title: document.getElementById('storybook-title').value,
                content: document.getElementById('storybook-content').value
            };
            
            const action = currentStorybookId
                ? db.collection('storybooks').doc(currentStorybookId).update(data)
                : db.collection('storybooks').add(data);

            await action;
            await updateWebsiteData();
            closeStorybookModal();
            btn.disabled = false;
            btn.textContent = 'Save';
        });

        // --- UTILS & HELPERS ---
        const deleteItem = (collection, id) => {
            if (confirm('Are you sure you want to delete this?')) {
                db.collection(collection).doc(id).delete().then(updateWebsiteData);
            }
        };

        const showTab = name => {
            document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
            document.getElementById(`${name}-tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('tab-active'));
            document.querySelector(`[data-tab="${name}"]`).classList.add('tab-active');
        };

        const dropZone = document.getElementById('image-drop-zone');
        const fileInput = document.getElementById('chocolate-image');
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleImage(e.dataTransfer.files[0]);
        };
        fileInput.onchange = (e) => { if (e.target.files.length) handleImage(e.target.files[0]); };

        function handleImage(file) {
            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('image-preview');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function updateWebsiteData() {
            console.log("Updating website data...");
            // Get active chocolates
            const chocoSnap = await db.collection('chocolates').get();
            const activeChocolates = chocoSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            await db.collection('website-data').doc('chocolates').set({ chocolates: activeChocolates });

            // Get all stories
            const storySnap = await db.collection('storybooks').get();
            const allStories = storySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            await db.collection('website-data').doc('storybooks').set({ storybooks: allStories });
            console.log("Website data updated successfully!");
        }
    </script>
</body>
</html>
